kind: pipeline
type: kubernetes
name: hulu-project

steps:
- name: restore-cache-with-filesystem
  image: meltwater/drone-cache
  pull: true
  settings:
    backend: "filesystem"
    restore: true
    cache_key: "hulu-project"
    archive_format: "gzip"
    # filesystem_cache_root: "/tmp/cache"
    mount:
      - 'vendor'
  volumes:
  - name: cache
    path: /tmp/cache

- name: docker-api
  image: plugins/docker
  settings:
    mirror: https://jnyis2wm.mirror.aliyuncs.com
    username:
      from_secret: username
    password:
      from_secret: password
    repo: registry-vpc.cn-shanghai.aliyuncs.com/hulu0811/huluproject-api
    registry: registry-vpc.cn-shanghai.aliyuncs.com
    tags:
      - latest
      - ${DRONE_COMMIT}

- name: dron8s-api
  image: bh90210/dron8s:latest
  settings:
    yaml: ./deploy.yaml
    image_tag: ${DRONE_COMMIT}
    kubeconfig:
        from_secret: kubeconfig

- name: rebuild-cache-with-filesystem
  image: meltwater/drone-cache
  pull: true
  settings:
    backend: "filesystem"
    rebuild: true
    cache_key: "hulu-project"
    archive_format: "gzip"
    # filesystem_cache_root: "/tmp/cache"
    mount:
      - 'vendor'
  volumes:
  - name: cache
    path: /tmp/cache

volumes:
  - name: cache
    host:
      path: /mnt/cache

---
kind: secret
name: username
get:
  path: docker-secret
  name: DOCKER_USERNAME

---
kind: secret
name: password
get:
  path: docker-secret
  name: DOCKER_PASSWORD

---
kind: secret
name: kubeconfig
get:
  path: kubeconfig
  name: KUBECONFIG